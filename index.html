<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post-it Jump Challenge - Classifica</title>

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome per icone -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Font personalizzati */
      .title-font {
        font-family: "Fredoka One", cursive;
      }

      .body-font {
        font-family: "Nunito", sans-serif;
      }

      /* Animazioni per i post-it */
      .post-it {
        transform: rotate(-2deg);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .post-it:hover {
        transform: rotate(0deg) scale(1.02);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }

      .post-it:nth-child(even) {
        transform: rotate(2deg);
      }

      /* Colori post-it alternati */
      .post-it-yellow {
        background: linear-gradient(45deg, #fef3c7, #fde047);
      }

      .post-it-pink {
        background: linear-gradient(45deg, #fce7f3, #f472b6);
      }

      .post-it-blue {
        background: linear-gradient(45deg, #dbeafe, #60a5fa);
      }

      .post-it-green {
        background: linear-gradient(45deg, #d1fae5, #34d399);
      }

      .post-it-orange {
        background: linear-gradient(45deg, #fed7aa, #fb923c);
      }

      /* Animazione di ingresso */
      .fade-in {
        animation: fadeIn 0.6s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Loader personalizzato */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #fde047;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Stile per le foto */
      .photo-frame {
        border: 3px solid #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Podio stile post-it */
      .podium-1 {
        background: linear-gradient(45deg, #fef3c7, #f59e0b);
        transform: scale(1.1);
      }

      .podium-2 {
        background: linear-gradient(45deg, #e5e7eb, #9ca3af);
      }

      .podium-3 {
        background: linear-gradient(45deg, #fed7aa, #ea580c);
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen body-font"
  >
    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-50">
      <div class="container mx-auto px-4 py-6">
        <div class="text-center">
          <h1
            class="title-font text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-600"
          >
            <i class="fas fa-sticky-note text-yellow-400 mr-2"></i>
            Post-it Jump Challenge
          </h1>
          <p class="text-gray-600 mt-2 text-lg">
            üöÄ Classifica Ufficiale dei Salti üèÜ
          </p>
          <p class="text-gray-500 mt-1 text-sm">
            üì∏
            <a
              href="https://drive.google.com/drive/folders/10EokpjgB7v1k9B5eaX_22OaXrOJifPIN_rMYs3cjP8ITFOofNnepMDldrinIrpO-OV7EvChb?usp=sharing"
              target="_blank"
              class="text-blue-500 hover:text-blue-700 underline"
              >Tutte le foto su Google Drive</a
            >
          </p>
          <div class="mt-4 flex justify-center items-center space-x-4">
            <div id="lastUpdate" class="text-sm text-gray-500"></div>
            <div id="refreshStatus" class="flex items-center">
              <div
                class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"
              ></div>
              <span class="text-sm text-green-600"
                >Auto-aggiornamento attivo</span
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Statistiche -->
    <section class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it post-it-yellow"
        >
          <i class="fas fa-users text-3xl text-yellow-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800" id="totalParticipants">
            0
          </h3>
          <p class="text-gray-600">Partecipanti</p>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it post-it-pink"
        >
          <i class="fas fa-trophy text-3xl text-pink-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800" id="bestJump">0 cm</h3>
          <p class="text-gray-600">Salto Migliore</p>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it post-it-blue"
        >
          <i class="fas fa-chart-line text-3xl text-blue-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800" id="averageJump">
            0 cm
          </h3>
          <p class="text-gray-600">Media</p>
        </div>
        <div
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it post-it-green"
        >
          <i class="fas fa-clock text-3xl text-green-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800" id="lastEntry">--</h3>
          <p class="text-gray-600">Ultimo Aggiornamento</p>
        </div>
      </div>
    </section>

    <!-- Pannello Admin (nascosto) -->
    <div
      id="adminPanel"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="container mx-auto px-4 py-8 h-full overflow-y-auto">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-2xl">
          <!-- Header Admin -->
          <div
            class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-t-xl"
          >
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold title-font">
                <i class="fas fa-shield-alt mr-2"></i>
                Pannello Amministrazione
              </h2>
              <button
                onclick="closeAdminPanel()"
                class="text-white hover:text-gray-200"
              >
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>
          </div>

          <!-- Login Admin -->
          <div id="adminLogin" class="p-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800">
              Accesso Amministratore
            </h3>
            <div class="space-y-4">
              <input
                type="password"
                id="adminPassword"
                placeholder="Password Admin"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                onkeypress="if(event.key==='Enter') adminLogin()"
              />
              <button
                onclick="adminLogin()"
                class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>Accedi
              </button>
              <p class="text-sm text-gray-600 text-center">
                üí° Combinazione tasti: Ctrl + Alt + A
              </p>
            </div>
          </div>

          <!-- Form Inserimento (nascosto inizialmente) -->
          <div id="adminForm" class="p-6 hidden">
            <h3 class="text-xl font-bold mb-6 text-gray-800">
              <i class="fas fa-plus-circle mr-2 text-green-600"></i>
              Aggiungi Partecipante
            </h3>

            <form id="participantForm" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Nome *</label
                  >
                  <input
                    type="text"
                    id="adminNome"
                    required
                    placeholder="Nome del partecipante"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Misura (cm) *</label
                  >
                  <input
                    type="number"
                    id="adminMisura"
                    required
                    placeholder="150"
                    min="0"
                    step="0.1"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >URL Foto</label
                >
                <input
                  type="url"
                  id="adminFoto"
                  placeholder="https://esempio.com/foto.jpg"
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <p class="text-xs text-gray-500 mt-1">
                  üí° Carica su Imgur, Google Photos, o altro servizio
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Corso di Laurea</label
                  >
                  <input
                    type="text"
                    id="adminCorso"
                    placeholder="Ingegneria Informatica"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Instagram</label
                  >
                  <input
                    type="text"
                    id="adminInstagram"
                    placeholder="@username"
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              <div class="flex space-x-4 pt-4">
                <button
                  type="submit"
                  class="flex-1 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition-colors"
                >
                  <i class="fas fa-plus mr-2"></i>Aggiungi Partecipante
                </button>
                <button
                  type="button"
                  onclick="clearForm()"
                  class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors"
                >
                  <i class="fas fa-eraser mr-2"></i>Pulisci
                </button>
              </div>
            </form>

            <!-- Lista Partecipanti Esistenti -->
            <div class="mt-8 border-t pt-6">
              <h4 class="text-lg font-bold mb-4 text-gray-800">
                <i class="fas fa-list mr-2 text-blue-600"></i>
                Gestione Partecipanti
              </h4>
              <div
                id="adminParticipantsList"
                class="space-y-2 max-h-60 overflow-y-auto"
              >
                <!-- Lista generata dinamicamente -->
              </div>
              <div class="mt-4 flex space-x-4">
                <button
                  onclick="refreshAdminData()"
                  class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-sync-alt mr-2"></i>Aggiorna Lista
                </button>
                <button
                  onclick="exportData()"
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                >
                  <i class="fas fa-download mr-2"></i>Esporta CSV
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="text-center py-8">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-600">Caricamento classifica...</p>
    </div>

    <!-- Messaggio di errore -->
    <div id="error" class="hidden text-center py-8">
      <div
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mx-auto max-w-md"
      >
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span id="errorMessage">Errore nel caricamento dei dati</span>
      </div>
    </div>

    <!-- Podio (Top 3) -->
    <section id="podium" class="container mx-auto px-4 py-8 hidden">
      <h2 class="text-3xl font-bold text-center mb-8 title-font text-gray-800">
        üèÜ Podio üèÜ
      </h2>
      <div
        class="flex flex-col md:flex-row justify-center items-end space-y-4 md:space-y-0 md:space-x-4"
      >
        <!-- 2¬∞ Posto -->
        <div
          id="secondPlace"
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it podium-2 md:w-64"
        >
          <!-- Contenuto generato dinamicamente -->
        </div>

        <!-- 1¬∞ Posto -->
        <div
          id="firstPlace"
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it podium-1 md:w-72"
        >
          <!-- Contenuto generato dinamicamente -->
        </div>

        <!-- 3¬∞ Posto -->
        <div
          id="thirdPlace"
          class="bg-white rounded-xl shadow-lg p-6 text-center post-it podium-3 md:w-64"
        >
          <!-- Contenuto generato dinamicamente -->
        </div>
      </div>
    </section>

    <!-- Classifica Completa -->
    <section id="leaderboard" class="container mx-auto px-4 py-8 hidden">
      <h2 class="text-3xl font-bold text-center mb-8 title-font text-gray-800">
        üìä Classifica Completa üìä
      </h2>
      <div
        id="leaderboardGrid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <!-- Contenuto generato dinamicamente -->
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-white shadow-lg mt-16">
      <div class="container mx-auto px-4 py-6 text-center">
        <p class="text-gray-600">
          <i class="fas fa-code text-blue-500 mr-1"></i>
          Sviluppato con ‚ù§Ô∏è per la Post-it Jump Challenge
        </p>
        <p class="text-sm text-gray-500 mt-2">
          Dati aggiornati automaticamente ogni 30 secondi
        </p>
      </div>
    </footer>

    <script>
      // ==========================================
      // CONFIGURAZIONE - MODIFICA QUESTI VALORI
      // ==========================================

      // URL del Google Sheet pubblicato come JSON
      // SOSTITUISCI "IL_TUO_ID_SHEET" con l'ID del tuo Google Sheet
      // Esempio: se il tuo URL √® https://docs.google.com/spreadsheets/d/1ABC123XYZ/edit
      // allora IL_TUO_ID_SHEET = 1ABC123XYZ
      const SHEET_URL =
        "https://docs.google.com/spreadsheets/d/1gGs3iZ_pdB-5vzxmgtAiaicOkfRhGfm8lWicXO7l2yE/gviz/tq?tqx=out:json";

      // Configurazione colonne del Google Sheet (indici base 0)
      // IMPORTANTE: Controlla l'ordine delle colonne nel tuo Google Sheet!
      const COLUMNS = {
        nome: 1, // Colonna B: Nome (A = Timestamp)
        misura: 2, // Colonna C: Misura (in cm)
        foto: 3, // Colonna D: URL foto
        corso: 4, // Colonna E: Corso di Laurea
        instagram: 5, // Colonna F: Instagram handle
      };

      // Intervallo di aggiornamento automatico (millisecondi)
      const REFRESH_INTERVAL = 300000; // 5 minuti (disabilitato temporaneamente)

      // ==========================================
      // CONFIGURAZIONE ADMIN
      // ==========================================

      // Password amministratore
      const ADMIN_PASSWORD = "aaaaaaaaa";

      // ==========================================
      // VARIABILI GLOBALI
      // ==========================================

      let participantsData = [];
      let refreshTimer = null;
      let isAdminLoggedIn = false;
      let isLoading = false; // Previene chiamate multiple

      // ==========================================
      // FUNZIONI PRINCIPALI
      // ==========================================

      /**
       * Inizializza l'applicazione
       */
      function initApp() {
        console.log("üöÄ Inizializzazione Post-it Jump Challenge");
        console.log("üåê Ambiente di hosting:", window.location.hostname);
        console.log("üìç URL completo:", window.location.href);
        console.log("üîó URL Google Sheet:", SHEET_URL);

        // Controllo specifico per GitHub Pages
        if (window.location.hostname.includes("github.io")) {
          console.log("üìò Rilevato GitHub Pages - Controlli aggiuntivi attivi");
          console.log("‚ö†Ô∏è Assicurati che il Google Sheet sia:");
          console.log("   1. Pubblicato sul web");
          console.log("   2. Accessibile a 'chiunque abbia il link'");
          console.log("   3. Non richieda autenticazione");
        }

        // Test di emergenza - forza fine caricamento dopo 10 secondi per GitHub Pages
        const timeoutDuration = window.location.hostname.includes("github.io")
          ? 10000
          : 5000;

        setTimeout(() => {
          if (isLoading) {
            console.log(
              `‚ö†Ô∏è Timeout caricamento dopo ${
                timeoutDuration / 1000
              } secondi - forzo la fine`
            );
            isLoading = false;
            showLoading(false);

            // Test con dati fittizi per verificare se il problema √® nel parsing o nel fetch
            console.log("üß™ Test con dati fittizi...");
            participantsData = [
              {
                nome: "Test Partecipante 1",
                misura: 150,
                foto: "https://via.placeholder.com/150x150?text=Test1",
                corso: "Test Course",
                instagram: "test_instagram1",
              },
              {
                nome: "Test Partecipante 2",
                misura: 140,
                foto: "https://via.placeholder.com/150x150?text=Test2",
                corso: "Test Course 2",
                instagram: "test_instagram2",
              },
            ];
            updateUI();
            updateLastUpdateTime();
            console.log("‚úÖ Test completato con dati fittizi");

            // Mostra messaggio specifico per GitHub Pages
            if (window.location.hostname.includes("github.io")) {
              showError(
                "Timeout caricamento dati da Google Sheets. Su GitHub Pages verifica le impostazioni di condivisione del foglio."
              );
            }
          }
        }, timeoutDuration);

        loadLeaderboard();
        startAutoRefresh();
      }

      /**
       * Carica i dati dal Google Sheet
       */
      async function loadLeaderboard() {
        // Previeni chiamate multiple
        if (isLoading) {
          console.log("‚è∏Ô∏è Caricamento gi√† in corso, ignoro la chiamata");
          return;
        }

        isLoading = true;
        console.log("üìä Caricamento dati dal Google Sheet...");
        console.log("üåê Ambiente:", window.location.hostname);

        try {
          showLoading(true);
          hideError();

          // Aggiungi headers per GitHub Pages
          const fetchOptions = {
            method: "GET",
            headers: {
              Accept: "text/plain, application/json, text/javascript, */*",
              "User-Agent": "Mozilla/5.0 (compatible; PostItChallenge/1.0)",
            },
            mode: "cors",
            cache: "no-cache",
          };

          console.log("üîó Tentativo connessione a:", SHEET_URL);
          const response = await fetch(SHEET_URL, fetchOptions);

          console.log(
            "üì° Status risposta:",
            response.status,
            response.statusText
          );
          console.log("üìã Headers risposta:", [...response.headers.entries()]);

          if (!response.ok) {
            if (response.status === 403) {
              throw new Error(
                "Accesso negato - Il Google Sheet deve essere pubblicato pubblicamente. Verifica che sia accessibile a chiunque abbia il link."
              );
            } else if (response.status === 404) {
              throw new Error(
                "Google Sheet non trovato - Verifica l'ID del documento"
              );
            } else if (response.status === 0) {
              throw new Error(
                "Errore CORS - GitHub Pages potrebbe bloccare la richiesta. Prova a rendere il Google Sheet pubblico."
              );
            } else {
              throw new Error(
                `Errore HTTP: ${response.status} - ${response.statusText}`
              );
            }
          }

          const text = await response.text();
          console.log("üìÑ Lunghezza risposta:", text.length, "caratteri");
          console.log("üîç Primi 100 caratteri:", text.substring(0, 100));

          // Verifica che sia il formato giusto
          if (!text.startsWith("/*O_o*/")) {
            console.error(
              "‚ùå Formato risposta non valido. Risposta completa:",
              text
            );
            throw new Error(
              "Formato risposta non valido - Il Google Sheet potrebbe non essere pubblicato correttamente. Assicurati che sia 'Accessibile a chiunque abbia il link'."
            );
          }

          // Rimuovi il prefisso Google Visualization API
          const jsonText = text.substring(47).slice(0, -2);
          console.log(
            "üîß JSON estratto (primi 200 caratteri):",
            jsonText.substring(0, 200)
          );

          const data = JSON.parse(jsonText);
          console.log(
            "‚úÖ Parsing JSON completato. Struttura:",
            Object.keys(data)
          );

          // Processa i dati
          participantsData = processSheetData(data);

          // Aggiorna l'interfaccia
          updateUI();
          updateLastUpdateTime();

          console.log(`‚úÖ Caricati ${participantsData.length} partecipanti`);
        } catch (error) {
          console.error("‚ùå Errore nel caricamento:", error);
          console.error("üìä Stack trace:", error.stack);

          // Messaggio di errore pi√π specifico per GitHub Pages
          let errorMessage = `Errore nel caricamento dei dati: ${error.message}`;

          if (window.location.hostname.includes("github.io")) {
            errorMessage +=
              "\n\nSu GitHub Pages assicurati che:\n1. Il Google Sheet sia pubblicato come 'Accessibile a chiunque abbia il link'\n2. Le impostazioni di condivisione permettano l'accesso senza autenticazione";
          }

          showError(errorMessage);
        } finally {
          showLoading(false);
          isLoading = false; // Libera il lock
        }
      }

      /**
       * Elabora i dati grezzi del Google Sheet
       */
      function processSheetData(data) {
        // Verifica che ci sia una tabella
        if (!data.table) {
          console.error("‚ùå Nessuna tabella trovata nei dati");
          return [];
        }

        const rows = data.table.rows;

        if (rows.length <= 0) {
          return [];
        }

        const participants = [];

        // Salta la prima riga (header)
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];

          // Verifica che la riga abbia celle
          if (!row.c) {
            continue;
          }

          // Verifica che la riga abbia almeno nome e misura
          const nome = row.c[COLUMNS.nome]
            ? getColumnValue(row.c[COLUMNS.nome])
            : null;
          const misura = row.c[COLUMNS.misura]
            ? getColumnValue(row.c[COLUMNS.misura])
            : null;

          if (!nome || !misura) {
            continue;
          }

          const participant = {
            nome: getColumnValue(row.c[COLUMNS.nome]),
            misura: parseFloat(getColumnValue(row.c[COLUMNS.misura])) || 0,
            foto: processPhotoUrl(getColumnValue(row.c[COLUMNS.foto])),
            corso: getColumnValue(row.c[COLUMNS.corso]) || "Non specificato",
            instagram: getColumnValue(row.c[COLUMNS.instagram]) || "",
          };

          // Valida i dati essenziali
          if (participant.nome && participant.misura > 0) {
            participants.push(participant);
          }
        }

        // Ordina per misura decrescente
        participants.sort((a, b) => b.misura - a.misura);

        return participants;
      }

      /**
       * Estrae il valore da una cella del Google Sheet
       */
      function getColumnValue(cell) {
        if (!cell) return "";
        const value = cell.v || cell.f || "";
        // Assicurati che il valore sia sempre una stringa
        return String(value);
      }

      /**
       * Aggiorna l'interfaccia utente
       */
      function updateUI() {
        updateStatistics();
        updatePodium();
        updateLeaderboard();

        // Mostra le sezioni
        document.getElementById("podium").classList.remove("hidden");
        document.getElementById("leaderboard").classList.remove("hidden");
      }

      /**
       * Processa l'URL della foto per renderlo utilizzabile
       */
      function processPhotoUrl(photoUrl) {
        if (!photoUrl || typeof photoUrl !== "string") {
          return "https://via.placeholder.com/150x150?text=No+Photo";
        }

        photoUrl = photoUrl.trim();

        // Se √® vuoto, usa placeholder
        if (!photoUrl) {
          return "https://via.placeholder.com/150x150?text=No+Photo";
        }

        // Se √® un URL di Google Drive, convertilo in un formato utilizzabile
        if (photoUrl.includes("drive.google.com")) {
          // Formato: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
          let fileIdMatch = photoUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);

          // Formato alternativo: https://drive.google.com/open?id=FILE_ID
          if (!fileIdMatch) {
            fileIdMatch = photoUrl.match(/[?&]id=([a-zA-Z0-9-_]+)/);
          }

          if (fileIdMatch) {
            // Prova prima con uc?export=view (ma spesso bloccato)
            // const convertedUrl1 = `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;

            // Usa direttamente lh3.googleusercontent che funziona meglio
            const convertedUrl2 = `https://lh3.googleusercontent.com/d/${fileIdMatch[1]}`;

            // Usa il metodo lh3 come default perch√© funziona meglio
            return convertedUrl2;
          } else {
            return "https://via.placeholder.com/150x150?text=Drive+Error";
          }
        }

        // Se non inizia con http, aggiungilo
        if (!photoUrl.startsWith("http")) {
          photoUrl = "https://" + photoUrl;
        }

        return photoUrl;
      }

      /**
       * Processa l'handle Instagram per renderlo utilizzabile
       */
      function processInstagramHandle(instagram) {
        if (!instagram || typeof instagram !== "string") {
          return "";
        }

        instagram = instagram.trim();

        // Se √® vuoto, restituisci stringa vuota
        if (!instagram) {
          return "";
        }

        // Rimuovi eventuali prefissi
        instagram = instagram.replace(/^@+/, ""); // Rimuovi @ all'inizio
        instagram = instagram.replace(/^instagram\.com\//, ""); // Rimuovi instagram.com/
        instagram = instagram.replace(/^www\.instagram\.com\//, ""); // Rimuovi www.instagram.com/
        instagram = instagram.replace(/^https?:\/\/[^\/]*instagram\.com\//, ""); // Rimuovi URL completi

        // Se contiene ancora caratteri non validi, pulisci
        instagram = instagram.replace(/[^a-zA-Z0-9._]/g, "");

        return instagram;
      }

      /**
       * Aggiorna le statistiche
       */
      function updateStatistics() {
        const total = participantsData.length;
        const best =
          total > 0 ? Math.max(...participantsData.map((p) => p.misura)) : 0;
        const average =
          total > 0
            ? (
                participantsData.reduce((sum, p) => sum + p.misura, 0) / total
              ).toFixed(1)
            : 0;

        document.getElementById("totalParticipants").textContent = total;
        document.getElementById("bestJump").textContent = `${best} cm`;
        document.getElementById("averageJump").textContent = `${average} cm`;
      }

      /**
       * Aggiorna il podio (top 3)
       */
      function updatePodium() {
        const podiumPositions = ["firstPlace", "secondPlace", "thirdPlace"];

        podiumPositions.forEach((position, index) => {
          const element = document.getElementById(position);
          const participant = participantsData[index];

          if (participant) {
            element.innerHTML = createPodiumCard(participant, index + 1);
          } else {
            element.innerHTML =
              '<p class="text-gray-500">In attesa di partecipanti...</p>';
          }
        });
      }

      /**
       * Crea una card per il podio
       */
      function createPodiumCard(participant, position) {
        const medals = ["ü•á", "ü•à", "ü•â"];

        console.log(
          "üéØ Instagram per",
          participant.nome,
          ":",
          participant.instagram,
          "tipo:",
          typeof participant.instagram
        );

        const instagramLink =
          participant.instagram &&
          typeof participant.instagram === "string" &&
          participant.instagram.trim() &&
          participant.instagram.trim() !== ""
            ? `<a href="https://instagram.com/${participant.instagram.replace(
                "@",
                ""
              )}" target="_blank" class="text-pink-500 hover:text-pink-700">
                    <i class="fab fa-instagram mr-1"></i>@${participant.instagram.replace(
                      "@",
                      ""
                    )}
                </a>`
            : "";

        return `
                <div class="mb-4">
                    <div class="text-4xl mb-2">${medals[position - 1]}</div>
                    <h3 class="text-xl font-bold text-gray-800">${position}¬∞ Posto</h3>
                </div>
                <div class="relative">
                    <img src="${participant.foto}" alt="${participant.nome}"
                         class="w-20 h-20 rounded-full mx-auto mb-4 photo-frame object-cover"
                         onerror="handleImageError(this, '${participant.foto}')"
                         data-original-src="${participant.foto}"
                         data-participant-name="${participant.nome}">
                </div>
                <h4 class="text-lg font-bold text-gray-800 mb-2">${
                  participant.nome
                }</h4>
                <div class="text-2xl font-bold text-blue-600 mb-2">${
                  participant.misura
                } cm</div>
                <p class="text-sm text-gray-600 mb-2">${participant.corso}</p>
                ${instagramLink}
            `;
      }

      /**
       * Aggiorna la classifica completa
       */
      function updateLeaderboard() {
        const grid = document.getElementById("leaderboardGrid");
        grid.innerHTML = "";

        participantsData.forEach((participant, index) => {
          const card = createLeaderboardCard(participant, index + 1);
          grid.appendChild(card);
        });
      }

      /**
       * Crea una card per la classifica
       */
      function createLeaderboardCard(participant, position) {
        const div = document.createElement("div");
        const colors = [
          "post-it-yellow",
          "post-it-pink",
          "post-it-blue",
          "post-it-green",
          "post-it-orange",
        ];
        const colorClass = colors[position % colors.length];

        const instagramLink =
          participant.instagram &&
          typeof participant.instagram === "string" &&
          participant.instagram.trim() &&
          participant.instagram.trim() !== ""
            ? `<a href="https://instagram.com/${participant.instagram.replace(
                "@",
                ""
              )}" target="_blank"
                   class="text-pink-500 hover:text-pink-700 text-sm">
                    <i class="fab fa-instagram mr-1"></i>@${participant.instagram.replace(
                      "@",
                      ""
                    )}
                </a>`
            : "";

        div.className = `bg-white rounded-xl shadow-lg p-6 text-center post-it ${colorClass} fade-in`;
        div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-gray-800 text-white text-sm font-bold px-2 py-1 rounded-full">
                        #${position}
                    </span>
                    <div class="text-2xl font-bold text-blue-600">${participant.misura} cm</div>
                </div>
                <div class="relative">
                    <img src="${participant.foto}" alt="${participant.nome}"
                         class="w-24 h-24 rounded-full mx-auto mb-4 photo-frame object-cover"
                         onerror="handleImageError(this, '${participant.foto}')"
                         data-original-src="${participant.foto}"
                         data-participant-name="${participant.nome}">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">${participant.nome}</h3>
                <p class="text-sm text-gray-600 mb-3">${participant.corso}</p>
                ${instagramLink}
            `;
        return div;
      }

      /**
       * Mostra/nasconde il loader
       */
      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      /**
       * Mostra un messaggio di errore
       */
      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("error").classList.remove("hidden");
      }

      /**
       * Nasconde il messaggio di errore
       */
      function hideError() {
        document.getElementById("error").classList.add("hidden");
      }

      /**
       * Scarica un'immagine
       */
      // Funzioni di download rimosse

      /**
       * Gestisce gli errori di caricamento delle immagini con fallback multipli
       */
      function handleImageError(img, originalUrl) {
        console.log("‚ùå Errore caricamento immagine:", originalUrl);

        // Se non ha ancora provato il fallback
        if (!img.dataset.fallbackAttempted) {
          img.dataset.fallbackAttempted = "1";

          // Prova a estrarre l'ID e usare lh3.googleusercontent
          if (originalUrl.includes("drive.google.com")) {
            let fileIdMatch = originalUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!fileIdMatch) {
              fileIdMatch = originalUrl.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            }

            if (fileIdMatch) {
              const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileIdMatch[1]}&sz=w300`;
              console.log("üîÑ Tentativo fallback con thumbnail:", thumbnailUrl);
              img.src = thumbnailUrl;
              return;
            }
          }
        }

        // Se anche il fallback fallisce, usa placeholder
        img.src =
          "https://via.placeholder.com/150x150?text=Foto+Non+Disponibile";
        console.log(
          "üîÑ Usando placeholder per:",
          img.dataset.participantName || "partecipante"
        );
      }

      /**
       * Aggiorna l'orario dell'ultimo aggiornamento
       */

      /**
       * Gestisce il download specifico per Google Drive
       */
      function downloadGoogleDriveImage(imageUrl, filename) {
        try {
          // Estrai l'ID del file da vari formati di URL
          let fileId = null;

          // Da lh3.googleusercontent.com
          if (imageUrl.includes("lh3.googleusercontent.com")) {
            const match = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) fileId = match[1];
          }

          // Da drive.google.com
          if (!fileId && imageUrl.includes("drive.google.com")) {
            let match = imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match) match = imageUrl.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            if (match) fileId = match[1];
          }

          if (fileId) {
            // Crea l'URL di download diretto per Google Drive
            const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            console.log("üì• URL download Google Drive:", downloadUrl);

            // Mostra un dialogo informativo con opzioni di download
            showDownloadDialog(downloadUrl, imageUrl, filename);
          } else {
            // Se non riesce a estrarre l'ID, apri in nuova finestra
            window.open(imageUrl, "_blank");
            showNotification(
              "Foto aperta in nuova finestra per download manuale",
              "info"
            );
          }
        } catch (error) {
          console.error("‚ùå Errore download Google Drive:", error);
          // Fallback: apri in nuova finestra
          window.open(imageUrl, "_blank");
          showNotification("Foto aperta in nuova finestra", "info");
        }
      }

      /**
       * Mostra un dialogo con opzioni per il download di Google Drive
       */
      function showDownloadDialog(downloadUrl, viewUrl, filename) {
        console.log("üé® Mostrando dialogo download:", {
          downloadUrl,
          viewUrl,
          filename,
        });

        // Rimuovi eventuali dialoghi esistenti
        const existingDialog = document.getElementById("download-dialog");
        if (existingDialog) {
          existingDialog.remove();
          console.log("üóëÔ∏è Dialogo esistente rimosso");
        }

        // Crea il dialogo
        const dialog = document.createElement("div");
        dialog.id = "download-dialog";
        dialog.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        dialog.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
            <div class="flex items-center mb-4">
              <i class="fas fa-download text-blue-500 text-2xl mr-3"></i>
              <h3 class="text-lg font-bold text-gray-800">Download Foto</h3>
            </div>
            <p class="text-gray-600 mb-6">Scegli come scaricare la foto di <strong>${filename.replace(
              "_foto",
              ""
            )}</strong>:</p>

            <div class="space-y-3">
              <button
                onclick="openDirectDownload('${downloadUrl}'); closeDownloadDialog();"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-download mr-2"></i>
                Download Diretto
              </button>

              <button
                onclick="openImageView('${viewUrl}'); closeDownloadDialog();"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-external-link-alt mr-2"></i>
                Apri e Salva Manualmente
              </button>

              <button
                onclick="copyToClipboard('${downloadUrl}'); closeDownloadDialog();"
                class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-copy mr-2"></i>
                Copia Link
              </button>
            </div>

            <button
              onclick="closeDownloadDialog()"
              class="w-full mt-4 text-gray-500 hover:text-gray-700 font-medium py-2">
              Annulla
            </button>
          </div>
        `;

        document.body.appendChild(dialog);

        // Chiudi cliccando fuori
        dialog.addEventListener("click", (e) => {
          if (e.target === dialog) {
            closeDownloadDialog();
          }
        });
      }

      /**
       * Apre il download diretto
       */
      function openDirectDownload(url) {
        window.open(url, "_blank");
        showNotification("Download avviato in nuova finestra", "success");
      }

      /**
       * Apre la visualizzazione dell'immagine per download manuale
       */
      function openImageView(url) {
        window.open(url, "_blank");
        showNotification(
          "Foto aperta per download manuale (tasto destro ‚Üí Salva immagine)",
          "info"
        );
      }

      /**
       * Copia il link negli appunti
       */
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          showNotification("Link copiato negli appunti!", "success");
        } catch (error) {
          console.error("Errore copia:", error);
          showNotification("Impossibile copiare il link", "error");
        }
      }

      /**
       * Chiude il dialogo di download
       */
      function closeDownloadDialog() {
        const dialog = document.getElementById("download-dialog");
        if (dialog) {
          dialog.remove();
        }
      }

      /**
       * Gestisce gli errori di caricamento delle immagini con fallback multipli
       */
      function handleImageError(img, originalUrl) {
        console.log("‚ùå Errore caricamento immagine:", originalUrl);

        // Se non ha ancora provato il fallback
        if (!img.dataset.fallbackAttempted) {
          img.dataset.fallbackAttempted = "1";

          // Prova a estrarre l'ID e usare lh3.googleusercontent
          if (originalUrl.includes("drive.google.com")) {
            let fileIdMatch = originalUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!fileIdMatch) {
              fileIdMatch = originalUrl.match(/[?&]id=([a-zA-Z0-9-_]+)/);
            }

            if (fileIdMatch) {
              const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileIdMatch[1]}&sz=w300`;
              console.log("üîÑ Tentativo fallback con thumbnail:", thumbnailUrl);
              img.src = thumbnailUrl;
              return;
            }
          }
        }

        // Se anche il fallback fallisce, usa placeholder
        img.src =
          "https://via.placeholder.com/150x150?text=Foto+Non+Disponibile";
        console.log(
          "üîÑ Usando placeholder per:",
          img.dataset.participantName || "partecipante"
        );
      }

      /**
       * Aggiorna l'orario dell'ultimo aggiornamento
       */
      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("it-IT");
        document.getElementById(
          "lastUpdate"
        ).textContent = `Ultimo aggiornamento: ${timeString}`;
        document.getElementById("lastEntry").textContent = timeString;
      }

      /**
       * Avvia l'aggiornamento automatico
       */
      function startAutoRefresh() {
        console.log(
          `‚è∞ Auto-refresh attivato (ogni ${REFRESH_INTERVAL / 1000} secondi)`
        );

        refreshTimer = setInterval(() => {
          console.log("üîÑ Aggiornamento automatico...");
          loadLeaderboard();
        }, REFRESH_INTERVAL);
      }

      /**
       * Ferma l'aggiornamento automatico
       */
      function stopAutoRefresh() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
          refreshTimer = null;
          console.log("‚èπÔ∏è Auto-refresh fermato");
        }
      }

      // ==========================================
      // FUNZIONI AMMINISTRAZIONE
      // ==========================================

      /**
       * Apre il pannello amministrazione
       */
      function openAdminPanel() {
        document.getElementById("adminPanel").classList.remove("hidden");

        // Controlla se √® gi√† loggato
        if (localStorage.getItem("adminLoggedIn") === "true") {
          showAdminForm();
        } else {
          showAdminLogin();
        }
      }

      /**
       * Chiude il pannello amministrazione
       */
      function closeAdminPanel() {
        document.getElementById("adminPanel").classList.add("hidden");
      }

      /**
       * Gestisce il login amministratore
       */
      function adminLogin() {
        const password = document.getElementById("adminPassword").value;

        if (password === ADMIN_PASSWORD) {
          isAdminLoggedIn = true;
          localStorage.setItem("adminLoggedIn", "true");
          showAdminForm();
          console.log("üîê Admin autenticato con successo");

          // Mostra notifica di successo
          showNotification("Login effettuato con successo!", "success");
        } else {
          showNotification("Password errata!", "error");
          document.getElementById("adminPassword").value = "";
        }
      }

      /**
       * Mostra il form di login admin
       */
      function showAdminLogin() {
        document.getElementById("adminLogin").classList.remove("hidden");
        document.getElementById("adminForm").classList.add("hidden");
        document.getElementById("adminPassword").focus();
      }

      /**
       * Mostra il form di inserimento admin
       */
      function showAdminForm() {
        document.getElementById("adminLogin").classList.add("hidden");
        document.getElementById("adminForm").classList.remove("hidden");
        refreshAdminData();
      }

      /**
       * Logout amministratore
       */
      function adminLogout() {
        isAdminLoggedIn = false;
        localStorage.removeItem("adminLoggedIn");
        showAdminLogin();
        console.log("üîê Admin logout");
      }

      /**
       * Gestisce l'inserimento di un nuovo partecipante
       */
      async function handleParticipantSubmit(event) {
        event.preventDefault();

        const formData = {
          nome: document.getElementById("adminNome").value.trim(),
          misura: parseFloat(document.getElementById("adminMisura").value) || 0,
          foto:
            document.getElementById("adminFoto").value.trim() ||
            "https://via.placeholder.com/150x150?text=No+Photo",
          corso:
            document.getElementById("adminCorso").value.trim() ||
            "Non specificato",
          instagram: document.getElementById("adminInstagram").value.trim(),
        };

        // Validazione
        if (!formData.nome || formData.misura <= 0) {
          showNotification("Nome e misura sono obbligatori!", "error");
          return;
        }

        try {
          console.log("üì§ Invio nuovo partecipante:", formData);

          // Per ora aggiungiamo localmente (in attesa della configurazione Google Apps Script)
          addParticipantLocally(formData);

          // TODO: Invia al Google Sheet tramite Apps Script
          // await sendToGoogleSheet(formData);

          clearForm();
          showNotification("Partecipante aggiunto con successo!", "success");

          // Aggiorna la classifica
          setTimeout(() => {
            loadLeaderboard();
          }, 1000);
        } catch (error) {
          console.error("‚ùå Errore aggiunta partecipante:", error);
          showNotification("Errore nell'aggiunta del partecipante", "error");
        }
      }

      /**
       * Aggiunge un partecipante localmente (temporaneo)
       */
      function addParticipantLocally(participant) {
        participantsData.push(participant);
        participantsData.sort((a, b) => b.misura - a.misura);
        updateUI();

        // Salva in localStorage per persistenza temporanea
        localStorage.setItem(
          "tempParticipants",
          JSON.stringify(participantsData)
        );
      }

      /**
       * Carica partecipanti temporanei dal localStorage
       */
      function loadLocalParticipants() {
        const saved = localStorage.getItem("tempParticipants");
        if (saved) {
          const localData = JSON.parse(saved);
          // Merge con i dati del Google Sheet
          localData.forEach((local) => {
            if (!participantsData.find((p) => p.nome === local.nome)) {
              participantsData.push(local);
            }
          });
          participantsData.sort((a, b) => b.misura - a.misura);
        }
      }

      /**
       * Invia dati al Google Sheet via Apps Script (da implementare)
       */
      async function sendToGoogleSheet(data) {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error("Errore invio dati al Google Sheet");
        }

        return response.json();
      }

      /**
       * Pulisce il form di inserimento
       */
      function clearForm() {
        document.getElementById("participantForm").reset();
        document.getElementById("adminNome").focus();
      }

      /**
       * Aggiorna i dati nel pannello admin
       */
      function refreshAdminData() {
        updateAdminParticipantsList();
      }

      /**
       * Aggiorna la lista partecipanti nel pannello admin
       */
      function updateAdminParticipantsList() {
        const list = document.getElementById("adminParticipantsList");

        if (participantsData.length === 0) {
          list.innerHTML =
            '<p class="text-gray-500 text-center py-4">Nessun partecipante</p>';
          return;
        }

        list.innerHTML = participantsData
          .map(
            (p, index) => `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center space-x-3">
              <span class="font-bold text-gray-700">#${index + 1}</span>
              <img src="${p.foto}" alt="${
              p.nome
            }" class="w-10 h-10 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/40x40?text=?'">
              <div>
                <p class="font-medium">${p.nome}</p>
                <p class="text-sm text-gray-600">${p.misura} cm</p>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="editParticipant(${index})" class="text-blue-600 hover:text-blue-800" title="Modifica">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteParticipant(${index})" class="text-red-600 hover:text-red-800" title="Elimina">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `
          )
          .join("");
      }

      /**
       * Elimina un partecipante
       */
      function deleteParticipant(index) {
        if (confirm(`Eliminare ${participantsData[index].nome}?`)) {
          participantsData.splice(index, 1);
          localStorage.setItem(
            "tempParticipants",
            JSON.stringify(participantsData)
          );
          updateUI();
          updateAdminParticipantsList();
          showNotification("Partecipante eliminato", "success");
        }
      }

      /**
       * Modifica un partecipante
       */
      function editParticipant(index) {
        const p = participantsData[index];
        document.getElementById("adminNome").value = p.nome;
        document.getElementById("adminMisura").value = p.misura;
        document.getElementById("adminFoto").value = p.foto;
        document.getElementById("adminCorso").value = p.corso;
        document.getElementById("adminInstagram").value = p.instagram;

        // Elimina il vecchio record
        participantsData.splice(index, 1);
        updateAdminParticipantsList();

        showNotification("Dati caricati per modifica", "info");
      }

      /**
       * Esporta dati in CSV
       */
      function exportData() {
        const csv = [
          ["Posizione", "Nome", "Misura (cm)", "Corso", "Instagram"],
          ...participantsData.map((p, i) => [
            i + 1,
            p.nome,
            p.misura,
            p.corso,
            p.instagram,
          ]),
        ]
          .map((row) => row.join(","))
          .join("\\n");

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `post-it-jump-${
          new Date().toISOString().split("T")[0]
        }.csv`;
        a.click();
        URL.revokeObjectURL(url);

        showNotification("Dati esportati!", "success");
      }

      /**
       * Mostra notifiche
       */
      function showNotification(message, type = "info") {
        const colors = {
          success: "bg-green-500",
          error: "bg-red-500",
          info: "bg-blue-500",
        };

        const notification = document.createElement("div");
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[9999] transition-all transform translate-x-full`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animazione di entrata
        setTimeout(() => {
          notification.classList.remove("translate-x-full");
        }, 100);

        // Rimozione automatica
        setTimeout(() => {
          notification.classList.add("translate-x-full");
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // ==========================================
      // EVENT LISTENERS
      // ==========================================

      // Inizializza l'app quando la pagina √® caricata
      document.addEventListener("DOMContentLoaded", initApp);

      // Gestisce la visibilit√† della pagina per pausare/riprendere l'auto-refresh
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          stopAutoRefresh();
          document.querySelector("#refreshStatus span").textContent =
            "Auto-aggiornamento in pausa";
          document
            .querySelector("#refreshStatus .w-3")
            .classList.remove("bg-green-400", "animate-pulse");
          document
            .querySelector("#refreshStatus .w-3")
            .classList.add("bg-gray-400");
        } else {
          startAutoRefresh();
          document.querySelector("#refreshStatus span").textContent =
            "Auto-aggiornamento attivo";
          document
            .querySelector("#refreshStatus .w-3")
            .classList.remove("bg-gray-400");
          document
            .querySelector("#refreshStatus .w-3")
            .classList.add("bg-green-400", "animate-pulse");
        }
      });

      // Refresh manuale con F5 o Ctrl+R
      document.addEventListener("keydown", (e) => {
        if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
          e.preventDefault();
          loadLeaderboard();
        }

        // Combinazione tasti admin: Ctrl + Alt + A
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "a") {
          e.preventDefault();
          openAdminPanel();
        }

        // Escape per chiudere il pannello admin
        if (e.key === "Escape") {
          closeAdminPanel();
        }
      });

      // Event listener per il form di inserimento partecipanti
      document.addEventListener("DOMContentLoaded", () => {
        // Aggiungi event listener al form
        const participantForm = document.getElementById("participantForm");
        if (participantForm) {
          participantForm.addEventListener("submit", handleParticipantSubmit);
        }

        // Carica partecipanti locali se presenti
        loadLocalParticipants();
      });

      console.log(
        "üìù Post-it Jump Challenge caricato! Modifica SHEET_URL per collegare il tuo Google Sheet."
      );
    </script>
  </body>
</html>
